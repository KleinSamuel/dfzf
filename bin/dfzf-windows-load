#!/usr/bin/env bash
[ -f "$HOME/.config/dfzf/dfzf.conf" ] && source "$HOME/.config/dfzf/dfzf.conf"
dfzf-exec -t get_tree --raw | jq -r --argjson map "${windows_app_id_map_json:-{\}}" '
  .. | objects 
  | select(.type == "con")
  | select(.window_type == null or .window_type == "normal") # specific for i3
  | select(.name != null)
  | select((.app_id // .window_properties.class) != null)
  | select((.app_id // .window_properties.class) != "dfzf-popup")
  | {
      "id": .id,
      "name": .name,
      "sort": ([.marks[] | select(startswith("_dfzf-sort"))] | first // "_dfzf-sort-0"),
      "app_id": (
        # Try to replace app_id with the key from the map, else fallback to original
        (.app_id // .window_properties.class) as $app_id |
        if $map[$app_id] then $map[$app_id] else $app_id end
      ),
      "urgent": .urgent,
      "important": ([.marks[] | select(startswith("_dfzf-important"))] | first | length > 0),
      "glyph": (
        if ((.name) | test("vim\\b"; "i")) then " "  # Neovim
        elif ((.app_id // .window_properties.class) | test("terminal"; "i")) then " "  # Terminal
        elif ((.app_id // .window_properties.class) | test("firefox"; "i")) then " "  # Firefox
        elif ((.app_id // .window_properties.class) | test("jetbrains"; "i")) then " "  # JetBrains IDEA
        elif ((.app_id // .window_properties.class) | test("gimp"; "i")) then " "  # Gimp
        elif ((.app_id // .window_properties.class) | test("thunar|nautilus"; "i")) then " "  # File manager
        else " "  # Default (rocket)
        end
      )
    } |
    "\(.sort) " + 
    (if .urgent == true then "\u001b[33m" else if .important == true then "\u001b[31m" else "" end end) + 
    "\(.glyph) [\(.app_id)]\t\(.name) #\(.id)" + 
    (if .urgent == true then "\u001b[0m" else if .important == true then "\u001b[0m" else "" end end)
' | sort -nr | sed -E "s/_dfzf-sort-[0-9]*//; s/${windows_title_rm_pattern:-— Mozilla Firefox }//"
